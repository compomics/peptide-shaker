package eu.isas.peptideshaker.gui.pride.annotationdialogs;

import com.compomics.util.Util;
import com.compomics.util.pride.prideobjects.Contact;
import java.awt.Color;
import javax.swing.JOptionPane;

/**
 * A dialog for creating new contacts and editing old ones.
 * 
 * @author Harald Barsnes
 */
public class NewContactDialog extends javax.swing.JDialog {

    /**
     * A reference to the NewContactGroupDialog.
     */
    private NewContactGroupDialog newContactGroupDialog;
    /**
     * The last valid input for contact name
     */
    private String lastNameInput = "";
    /**
     * The index of the modified row, if any.
     */
    private int modifiedRow = -1;

    /**
     * Creates a new NewContactDialog.
     * 
     * @param newContactGroupDialog
     * @param modal 
     */
    public NewContactDialog(NewContactGroupDialog newContactGroupDialog, boolean modal) {
        super(newContactGroupDialog, modal);
        this.newContactGroupDialog = newContactGroupDialog;
        initComponents();
        setLocationRelativeTo(newContactGroupDialog);
        setVisible(true);
    }
    
    /**
     * Creates a new NewContactDialog.
     * 
     * @param newContactGroupDialog
     * @param modal
     * @param contact
     * @param modifiedRow
     */
    public NewContactDialog(NewContactGroupDialog newContactGroupDialog, boolean modal, Contact contact, int modifiedRow) {
        super(newContactGroupDialog, modal);
        this.newContactGroupDialog = newContactGroupDialog;
        this.modifiedRow = modifiedRow;
        initComponents();
        
        nameJTextField.setText(contact.getName());
        eMailJTextField.setText(contact.getEMail());
        institutionJTextArea.setText(contact.getInstitution());
        validateInput();
        
        setTitle("Edit Contact");
        
        setLocationRelativeTo(newContactGroupDialog);
        setVisible(true);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        backgroundPanel = new javax.swing.JPanel();
        contactPanel = new javax.swing.JPanel();
        institutionLabel = new javax.swing.JLabel();
        nameLabel = new javax.swing.JLabel();
        eMailLabel = new javax.swing.JLabel();
        eMailJTextField = new javax.swing.JTextField();
        jScrollPane2 = new javax.swing.JScrollPane();
        institutionJTextArea = new javax.swing.JTextArea();
        nameJTextField = new javax.swing.JTextField();
        okJButton = new javax.swing.JButton();
        cancelJButton = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("New Contact");
        setResizable(false);

        backgroundPanel.setBackground(new java.awt.Color(230, 230, 230));

        contactPanel.setBorder(javax.swing.BorderFactory.createTitledBorder("Contact"));
        contactPanel.setOpaque(false);

        institutionLabel.setForeground(new java.awt.Color(255, 0, 0));
        institutionLabel.setText("Institution*");

        nameLabel.setForeground(new java.awt.Color(255, 0, 0));
        nameLabel.setText("Name*");

        eMailLabel.setForeground(new java.awt.Color(255, 0, 0));
        eMailLabel.setText("E-mail*");

        eMailJTextField.setFont(eMailJTextField.getFont());
        eMailJTextField.setMargin(new java.awt.Insets(2, 4, 2, 2));
        eMailJTextField.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                eMailJTextFieldKeyReleased(evt);
            }
        });

        institutionJTextArea.setColumns(20);
        institutionJTextArea.setFont(institutionJTextArea.getFont());
        institutionJTextArea.setLineWrap(true);
        institutionJTextArea.setRows(2);
        institutionJTextArea.setWrapStyleWord(true);
        institutionJTextArea.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                institutionJTextAreaKeyReleased(evt);
            }
        });
        jScrollPane2.setViewportView(institutionJTextArea);

        nameJTextField.setFont(nameJTextField.getFont());
        nameJTextField.setMargin(new java.awt.Insets(2, 4, 2, 2));
        nameJTextField.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                nameJTextFieldKeyReleased(evt);
            }
        });

        javax.swing.GroupLayout contactPanelLayout = new javax.swing.GroupLayout(contactPanel);
        contactPanel.setLayout(contactPanelLayout);
        contactPanelLayout.setHorizontalGroup(
            contactPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(contactPanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(contactPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(eMailLabel)
                    .addComponent(nameLabel)
                    .addComponent(institutionLabel))
                .addGap(16, 16, 16)
                .addGroup(contactPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane2, javax.swing.GroupLayout.DEFAULT_SIZE, 427, Short.MAX_VALUE)
                    .addComponent(eMailJTextField, javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(nameJTextField))
                .addContainerGap())
        );
        contactPanelLayout.setVerticalGroup(
            contactPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(contactPanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(contactPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(nameLabel)
                    .addComponent(nameJTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(contactPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(eMailJTextField)
                    .addComponent(eMailLabel))
                .addGroup(contactPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(contactPanelLayout.createSequentialGroup()
                        .addGap(10, 10, 10)
                        .addComponent(jScrollPane2, javax.swing.GroupLayout.DEFAULT_SIZE, 188, Short.MAX_VALUE))
                    .addGroup(contactPanelLayout.createSequentialGroup()
                        .addGap(46, 46, 46)
                        .addComponent(institutionLabel)
                        .addGap(0, 0, Short.MAX_VALUE)))
                .addContainerGap())
        );

        okJButton.setText("OK");
        okJButton.setEnabled(false);
        okJButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                okJButtonActionPerformed(evt);
            }
        });

        cancelJButton.setText("Cancel");
        cancelJButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cancelJButtonActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout backgroundPanelLayout = new javax.swing.GroupLayout(backgroundPanel);
        backgroundPanel.setLayout(backgroundPanelLayout);
        backgroundPanelLayout.setHorizontalGroup(
            backgroundPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(backgroundPanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(backgroundPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(contactPanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, backgroundPanelLayout.createSequentialGroup()
                        .addGap(0, 0, Short.MAX_VALUE)
                        .addComponent(okJButton)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(cancelJButton)))
                .addContainerGap())
        );

        backgroundPanelLayout.linkSize(javax.swing.SwingConstants.HORIZONTAL, new java.awt.Component[] {cancelJButton, okJButton});

        backgroundPanelLayout.setVerticalGroup(
            backgroundPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(backgroundPanelLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(contactPanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(backgroundPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(okJButton)
                    .addComponent(cancelJButton))
                .addContainerGap())
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(backgroundPanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(backgroundPanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    /**
     * @see #validateInput() 
     */
    private void eMailJTextFieldKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_eMailJTextFieldKeyReleased
        validateInput();
    }//GEN-LAST:event_eMailJTextFieldKeyReleased

    /**
     * @see #validateInput() 
     */
    private void institutionJTextAreaKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_institutionJTextAreaKeyReleased
        validateInput();
    }//GEN-LAST:event_institutionJTextAreaKeyReleased

    /**
     * @see #validateInput() 
     */
    private void nameJTextFieldKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_nameJTextFieldKeyReleased
        validateInput();
    }//GEN-LAST:event_nameJTextFieldKeyReleased

    /**
     * Saves the contact and closes the dialog.
     * 
     * @param evt 
     */
    private void okJButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_okJButtonActionPerformed
        Contact tempContact = new Contact(nameJTextField.getText(), eMailJTextField.getText(), institutionJTextArea.getText());
        
        if (modifiedRow != -1) {
            newContactGroupDialog.editContact(tempContact, modifiedRow);
        } else {
            newContactGroupDialog.insertContact(tempContact);
        }

        dispose();
    }//GEN-LAST:event_okJButtonActionPerformed

    /**
     * Close the dialog without saving.
     * 
     * @param evt 
     */
    private void cancelJButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cancelJButtonActionPerformed
        dispose();
    }//GEN-LAST:event_cancelJButtonActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel backgroundPanel;
    private javax.swing.JButton cancelJButton;
    private javax.swing.JPanel contactPanel;
    private javax.swing.JTextField eMailJTextField;
    private javax.swing.JLabel eMailLabel;
    private javax.swing.JTextArea institutionJTextArea;
    private javax.swing.JLabel institutionLabel;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JTextField nameJTextField;
    private javax.swing.JLabel nameLabel;
    private javax.swing.JButton okJButton;
    // End of variables declaration//GEN-END:variables

    /**
     * Checks if all mandatory information is filled in. Enables or disables the
     * OK button.
     */
    private void validateInput() {
        
        String input = nameJTextField.getText();
        for (String forbiddenCharacter : Util.forbiddenCharacters) {
            if (input.contains(forbiddenCharacter)) {
                JOptionPane.showMessageDialog(null, "'" + forbiddenCharacter + "' is not allowed in contact name.",
                    "Forbidden Character", JOptionPane.WARNING_MESSAGE);
                nameJTextField.setText(lastNameInput);
                return;
            }
        }
        lastNameInput = input;
        
        if (nameJTextField.getText().length() > 0 
                && eMailJTextField.getText().length() > 0
                && institutionJTextArea.getText().length() > 0) {
            okJButton.setEnabled(true);
        } else {
            okJButton.setEnabled(false);
        }
        
        // highlight the fields that have not been filled
        if (nameJTextField.getText().length() > 0) {
            nameLabel.setForeground(Color.BLACK);
        } else {
            nameLabel.setForeground(Color.RED);
        }
        
        if (eMailJTextField.getText().length() > 0) {
            eMailLabel.setForeground(Color.BLACK);
        } else {
            eMailLabel.setForeground(Color.RED);
        }
        
        if (institutionJTextArea.getText().length() > 0) {
            institutionLabel.setForeground(Color.BLACK);
        } else {
            institutionLabel.setForeground(Color.RED);
        }
    }
}
